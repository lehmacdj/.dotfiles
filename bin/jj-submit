#!/usr/bin/env bash
set -euo pipefail

if [ $# -lt 1 ] || [ $# -gt 2 ]; then
  echo "Usage: $0 <bookmark-name> [<change>]"
  exit 1
fi

bookmark_name="$1"

if [ $# -eq 2 ]; then
  change="$2"
else
  change=""
fi

bookmark_exists=""
if { jj bookmark list || true; } | grep -q "$1"; then
  [ -z "$change" ] && change="$1"
  bookmark_exists=1
else
  [ -z "$change" ] && change="@"
fi

if [ -z "$bookmark_exists" ]; then
  jj bookmark create -r "$change" "$bookmark_name"
else
  jj bookmark set -r "$change" "$bookmark_name"
fi
jj git push --bookmark "$bookmark_name" --allow-new

gt track "$bookmark_name"
gt submit --branch "$bookmark_name"
