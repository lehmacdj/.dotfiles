#!/usr/bin/env bash
set -euo pipefail

if [ $# -ne 1 ]; then
  echo "Usage: $0 <change>"
  exit 1
fi

change="$1"
# produce a string like "devin/factor-listeningchallengeprom/wswz"
bookmark_name="$(\
  jj show "$change" --no-patch 2>&1 --template 'change_bookmark' \
)"

bookmark_exists=""
if { jj bookmark list || true; } | grep -q "$bookmark_name"; then
  bookmark_exists=1
fi

if [ -z "$bookmark_exists" ]; then
  jj bookmark create -r "$change" "$bookmark_name"
else
  jj bookmark set -r "$change" "$bookmark_name"
fi
jj git push --bookmark "$bookmark_name" --allow-new

if command -v gt >/dev/null 2>&1; then
  gt track "$bookmark_name"
  gt submit --branch "$bookmark_name" --draft --no-web --no-edit-description --view
elif command -v gh >/dev/null 2>&1; then
  gh pr create --head "$bookmark_name" --draft --web
else
  >&2 echo "Neither 'gt' nor 'gh' installed; create a pull request manually."
fi
