#!/usr/bin/env bash
set -euo pipefail

if [ $# -ne 1 ]; then
  echo "Usage: $0 <change>"
  exit 1
fi

change="$1"
# produce a string like "devin/factor-listeningchallengeprom/wswz"
bookmark_name="devin/$(\
  jj show "$change" --no-patch 2>&1 \
    --template '
        description
          .first_line()
          .trim()
          .replace(regex:"[+\"'"'"'`.():]", "")
          .replace(regex:"[ /]", "-")
          .replace(regex:"-{2,}", "-")
          .substr(0,29)
        ++ "/"
        ++ stringify(change_id).substr(0, 4)
      ' \
    | tr '[:upper:]' '[:lower:]'
)"

bookmark_exists=""
if { jj bookmark list || true; } | grep -q "$bookmark_name"; then
  bookmark_exists=1
fi

if [ -z "$bookmark_exists" ]; then
  jj bookmark create -r "$change" "$bookmark_name"
else
  jj bookmark set -r "$change" "$bookmark_name"
fi
jj git push --bookmark "$bookmark_name" --allow-new

if command -v gt >/dev/null 2>&1; then
  gt track "$bookmark_name"
  gt submit --branch "$bookmark_name"
elif command -v gh >/dev/null 2>&1; then
  gh pr create --head "$bookmark_name" --web
else
  >&2 echo "Neither 'gt' nor 'gh' installed; create a pull request manually."
fi
