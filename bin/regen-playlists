#!/usr/bin/env bash
set -e

# update generated playlists in beets config file based on the output
# of beet-styles/beet-moods

temp_playlists="$(mktemp)"
>&2 echo "using temp file: $temp_playlists"
start_marker="# START: AUTOGENERATED-PLAYLISTS"
warning_marker="# WARNING: manual modifications may be overwritten"
end_marker="# END: AUTOGENERATED-PLAYLISTS"
echo >> "$temp_playlists" "$warning_marker"
count=0
for i in $(beet-moods); do
  count=$((count + 1))
  printf >> "$temp_playlists" \
    "    - name: mood-%s.m3u\n      query: 'mood:%s'\n" "$i" "$i"
done
for i in $(beet-styles); do
  count=$((count + 1))
  printf >> "$temp_playlists" \
    "    - name: style-%s.m3u\n      query: 'style:%s'\n" "$i" "$i"
done
echo >> "$temp_playlists" "$end_marker"
config_file="$(beet config -p)"
suffix='.regen-playlists-temp~'
# delete the section between warning and end (inclusive) and then write the
# contents of the temp file after the start marker
sed -i "$suffix" \
  -e "/$warning_marker/,/$end_marker/d;/$start_marker/r $temp_playlists" \
  "$config_file"
rm "${config_file}$suffix"
>&2 echo "regenerated $count playlists"

# actually do the regenerating of the playlists
find "$HOME/Music/beets/library/Playlists/" -type f -name '*.m3u' -delete
beet splupdate
