#!/usr/bin/env bash
set -euo pipefail

# Configuration
XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
HISTORY_FILE="${WALLPAPER_HISTORY_FILE:-$XDG_DATA_HOME/skipped-wallpapers}"

# Function to get current wallpaper paths
get_wallpapers() {
  lsof -c Wallpaper 2>/dev/null \
    | grep -E "\.(jpg|jpeg|png|heic|heif|webp)" \
    | awk '{print $NF}' \
    | sort -u \
    | xargs -I {} stat -f "%a {}" {} 2>/dev/null \
    | sort -rn \
    | awk '{$1=""; print substr($0,2)}'
}

# Show usage if no argument provided
if [ $# -eq 0 ]; then
  echo "Usage: wallpaper <show|skip>" >&2
  echo "  show - Display current wallpaper file paths" >&2
  echo "  skip - Skip current wallpaper and switch to next" >&2
  exit 1
fi

command="$1"

case "$command" in
  show)
    # Display current wallpapers
    wallpapers=$(get_wallpapers)
    if [ -n "$wallpapers" ]; then
      echo "$wallpapers"
    else
      echo "No wallpapers currently detected" >&2
      exit 1
    fi
    ;;

  skip)
    # Get all current wallpaper paths before switching
    wallpapers=$(get_wallpapers | tr '\n' ' ')

    # Ensure the data directory exists
    mkdir -p "$(dirname "$HISTORY_FILE")"

    # Get current timestamp in ISO8601 UTC format
    timestamp=$(date -u "+%Y-%m-%dT%H:%M:%SZ")

    # Log skip action to history file
    # Log all wallpapers on one line, space-separated
    if [ -n "$wallpapers" ]; then
      echo "$timestamp $wallpapers" >> "$HISTORY_FILE"
    fi

    # Trigger wallpaper change by restarting WallpaperAgent
    killall WallpaperAgent

    >&2 echo "Wallpaper skipped and switched. History logged to: $HISTORY_FILE"
    ;;

  *)
    echo "Error: Unknown command '$command'" >&2
    echo "Usage: wallpaper <show|skip>" >&2
    exit 1
    ;;
esac
