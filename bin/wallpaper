#!/usr/bin/env bash
set -euo pipefail

# Configuration
XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
HISTORY_FILE="${WALLPAPER_HISTORY_FILE:-$XDG_DATA_HOME/skipped-wallpapers}"

# Function to get current wallpaper paths
get_wallpapers() {
  lsof -c Wallpaper 2>/dev/null \
    | grep -E "\.(jpg|jpeg|png|heic|heif|webp)" \
    | awk '{print $NF}' \
    | sort -u \
    | xargs -I {} stat -f "%a {}" {} 2>/dev/null \
    | sort -rn \
    | awk '{$1=""; print substr($0,2)}'
}

# Filter wallpapers by NID or filename suffix
# Usage: get_wallpapers | filter_wallpapers target1 target2 ...
filter_wallpapers() {
  local targets=("$@")
  while read -r path; do
    local basename="${path##*/}"
    local nid="${basename%.*}"
    for target in "${targets[@]}"; do
      if [[ "$target" == @* && "${target#@}" == "$nid" ]] \
        || [[ "$target" == "$nid" ]] \
        || [[ "$path" == *"$target" ]]; then
        echo "$path"
        break
      fi
    done
  done
}

# Show usage if no argument provided
if [ $# -eq 0 ]; then
  echo "Usage: wallpaper <show|skip|trash>" >&2
  echo "  show  - Display current wallpaper file paths" >&2
  echo "  skip  - Skip current wallpaper and switch to next" >&2
  echo "  trash [NID|filename ...] - Remove wallpaper(s)" \
    "and switch to next" >&2
  exit 1
fi

command="$1"
shift
targets=("$@")

case "$command" in
  show)
    verb="showed"
    ;;
  skip)
    verb="skipped"
    ;;
  trash)
    verb="trashed"
    ;;

  *)
    echo "Error: Unknown command '$command'" >&2
    echo "Usage: wallpaper <show|skip|trash>" >&2
    exit 1
    ;;
esac

# Get selected wallpapers (filtered if targets given)
selected_wallpapers() {
  if [ ${#targets[@]} -eq 0 ]; then
    get_wallpapers
  else
    get_wallpapers | filter_wallpapers "${targets[@]}"
  fi
}

# get wallpaper str before wallpaper might get changed
wallpapers_ansi=$(selected_wallpapers | while read -r path; do
  basename="${path##*/}"
  basename="${basename%.*}"
  echo "@$basename $(ansi-url "$path")"
done)

if [ ${#targets[@]} -gt 0 ] && [ -z "$wallpapers_ansi" ]; then
  >&2 echo "No matching wallpapers found"
  exit 1
fi

# Ensure the data directory exists
mkdir -p "$(dirname "$HISTORY_FILE")"

# Get current timestamp in ISO8601 UTC format
timestamp=$(date -u "+%Y-%m-%dT%H:%M:%SZ")
# get log str before wallpaper gets changed
log_str="$timestamp $verb $(selected_wallpapers | tr '\n' ' ')"

if [ "$command" = "trash" ]; then
  selected_wallpapers | xargs -n1 trash
fi

if [ "$command" = "skip" ] || [ "$command" = "trash" ]; then
  # Trigger wallpaper change by restarting WallpaperAgent
  killall WallpaperAgent

  # Log action to history file
  [ -n "$log_str" ] && echo "$log_str" >> "$HISTORY_FILE"
  >&2 echo "Wallpaper $verb and switched, was:"
fi

if [ -n "$wallpapers_ansi" ]; then
  echo "$wallpapers_ansi"
else
   >&2 echo "No wallpapers currently detected"
  exit 1
fi
