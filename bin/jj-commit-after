#!/usr/bin/env bash
set -euo pipefail

if [ $# -lt 1 ]; then
  echo "Usage: $0 <bookmark/change name> [-k|--keep-message] <jj commit args...>"
  exit 1
fi

change_name="$1"
shift
keep_message=
if [ $# -ge 1 ] && { [ "$1" = "-k" ] || [ "$1" = "--keep-message" ]; }; then
  keep_message=1
  shift
fi

if [ -n "$keep_message" ]; then
  jj new
else
  jj commit "$@"
fi
jj rebase -r @- -A "$change_name" -B "$change_name+"
# $change_name+ now refers to the new commit
jj bookmark move --from "$change_name" --to "$change_name+"
