#!/usr/bin/env bash
set -euo pipefail

# Configuration
XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
HISTORY_FILE="${WALLPAPER_HISTORY_FILE:-$XDG_DATA_HOME/skipped-wallpapers}"

# Ensure the data directory exists
mkdir -p "$(dirname "$HISTORY_FILE")"

# Get all current wallpaper paths before switching
# Use lsof to find the actual image files being displayed
# Sort by access time (most recently accessed first) to prioritize active display
wallpapers=$(\
  lsof 2>/dev/null \
    | grep -i "wallpaper" \
    | grep -E "\.(jpg|jpeg|png|heic|heif|webp)" \
    | awk '{print $NF}' \
    | sort -u \
    | xargs -I {} stat -f "%a {}" {} 2>/dev/null \
    | sort -rn \
    | awk '{$1=""; print substr($0,2)}' \
    | tr '\n' ' ' \
)

# Get current timestamp in ISO8601 UTC format
timestamp=$(date -u "+%Y-%m-%dT%H:%M:%SZ")

# Log skip action to history file
# Log all wallpapers on one line, space-separated
if [ -n "$wallpapers" ]; then
    echo "$timestamp $wallpapers" >> "$HISTORY_FILE"
fi

# Trigger wallpaper change by restarting WallpaperAgent
killall WallpaperAgent

>&2 echo "Wallpaper skipped and switched. History logged to: $HISTORY_FILE"
